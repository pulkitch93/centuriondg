import { dispatchStorage } from './dispatchStorage';
import { schedulerStorage } from './schedulerStorage';
import { storage } from './storage';
import { DispatchTicket, Driver } from '@/types/dispatch';

const DISPATCH_DATA_VERSION = 'v2'; // Increment to force refresh

export function initializeDispatchData() {
  const existingDrivers = dispatchStorage.getDrivers();
  const existingTickets = dispatchStorage.getDispatchTickets();
  const dataVersion = localStorage.getItem('dispatch_data_version');
  
  // Check if we have enough delivered tickets in the past 7 days for metrics
  const now = new Date();
  const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  const recentDeliveries = existingTickets.filter(t => 
    t.deliveredAt && new Date(t.deliveredAt) >= sevenDaysAgo
  );
  const recentVolume = recentDeliveries.reduce((sum, t) => sum + (t.actualVolume || t.volume), 0);
  
  // Force refresh if version changed, or if we don't have enough volume data
  if (dataVersion === DISPATCH_DATA_VERSION && existingDrivers.length >= 8 && recentVolume >= 1000) {
    return;
  }
  
  localStorage.setItem('dispatch_data_version', DISPATCH_DATA_VERSION);

  const drivers: Driver[] = [
    {
      id: 'driver-1',
      name: 'Marcus Hill',
      haulerId: 'hauler-1',
      truckType: 'tri-axle' as const,
      truckCapacity: 18,
      licensePlate: 'NC-8472',
      certifications: ['Clean fill certified', 'DOT certified'],
      performanceScore: 96,
      phone: '(704) 555-0101',
      status: 'available' as const,
      currentLocation: { lat: 35.2271, lng: -80.8431 },
    },
    {
      id: 'driver-2',
      name: 'Sofia Reyes',
      haulerId: 'hauler-2',
      truckType: 'quad-axle' as const,
      truckCapacity: 20,
      licensePlate: 'NC-9203',
      certifications: ['Hazmat', 'DOT certified', 'Heavy haul'],
      performanceScore: 89,
      phone: '(704) 555-0102',
      status: 'on-job' as const,
      currentLocation: { lat: 35.1165, lng: -80.7234 },
    },
    {
      id: 'driver-3',
      name: 'Jordan Lee',
      haulerId: 'hauler-3',
      truckType: 'dump-truck' as const,
      truckCapacity: 15,
      licensePlate: 'NC-5619',
      certifications: ['DOT certified'],
      performanceScore: 73,
      phone: '(704) 555-0103',
      status: 'available' as const,
      currentLocation: { lat: 35.0515, lng: -80.8484 },
    },
    {
      id: 'driver-4',
      name: 'Chen Wu',
      haulerId: 'hauler-4',
      truckType: 'semi-trailer' as const,
      truckCapacity: 25,
      licensePlate: 'NC-2847',
      certifications: ['DOT certified', 'Heavy haul', 'Clean fill certified'],
      performanceScore: 92,
      phone: '(704) 555-0104',
      status: 'available' as const,
      currentLocation: { lat: 35.3074, lng: -80.7307 },
    },
    {
      id: 'driver-5',
      name: 'Isabella Martinez',
      haulerId: 'hauler-1',
      truckType: 'tri-axle' as const,
      truckCapacity: 18,
      licensePlate: 'NC-6739',
      certifications: ['DOT certified', 'Clean fill certified'],
      performanceScore: 88,
      phone: '(704) 555-0105',
      status: 'available' as const,
      currentLocation: { lat: 34.9249, lng: -81.0251 },
    },
    {
      id: 'driver-6',
      name: 'James Thompson',
      haulerId: 'hauler-2',
      truckType: 'quad-axle' as const,
      truckCapacity: 20,
      licensePlate: 'NC-4821',
      certifications: ['Hazmat', 'DOT certified'],
      performanceScore: 79,
      phone: '(704) 555-0106',
      status: 'off-duty' as const,
      currentLocation: { lat: 35.2141, lng: -80.8547 },
    },
    {
      id: 'driver-7',
      name: 'Aisha Patel',
      haulerId: 'hauler-3',
      truckType: 'dump-truck' as const,
      truckCapacity: 16,
      licensePlate: 'NC-9102',
      certifications: ['DOT certified'],
      performanceScore: 94,
      phone: '(704) 555-0107',
      status: 'available' as const,
      currentLocation: { lat: 35.2271, lng: -80.8431 },
    },
    {
      id: 'driver-8',
      name: 'Robert Johnson',
      haulerId: 'hauler-4',
      truckType: 'articulated' as const,
      truckCapacity: 22,
      licensePlate: 'SC-3456',
      certifications: ['DOT certified', 'Heavy haul', 'Clean fill certified'],
      performanceScore: 85,
      phone: '(803) 555-0108',
      status: 'available' as const,
      currentLocation: { lat: 35.1165, lng: -80.7234 },
    },
  ];

  dispatchStorage.setDrivers(drivers);

  const currentTime = new Date();
  const tickets: DispatchTicket[] = [
    {
      id: 'T-9001',
      scheduleId: 'DS-5001',
      driverId: 'driver-1',
      haulerCompany: 'Rapid Logistics',
      exportSiteId: 'EX-103',
      importSiteId: 'IM-202',
      volume: 180,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 1 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 1 * 24 * 60 * 60 * 1000 + 15 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 1 * 24 * 60 * 60 * 1000 + 30 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 1 * 24 * 60 * 60 * 1000 + 75 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 1 * 24 * 60 * 60 * 1000 + 135 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      digitalSignature: 'signature-9001',
      actualVolume: 180,
      customerRating: 5,
      fuelUsed: 85,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9002',
      scheduleId: 'DS-5002',
      driverId: 'driver-2',
      haulerCompany: 'GreenHaul Transport',
      exportSiteId: 'EX-101',
      importSiteId: 'IM-201',
      volume: 200,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 10 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 30 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 80 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 150 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      actualVolume: 200,
      customerRating: 4,
      fuelUsed: 102,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9003',
      scheduleId: 'DS-5003',
      driverId: 'driver-3',
      haulerCompany: 'Budget Movers',
      exportSiteId: 'EX-102',
      importSiteId: 'IM-203',
      volume: 150,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 20 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 45 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 90 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 150 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      actualVolume: 150,
      customerRating: 4.5,
      fuelUsed: 78,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9004',
      scheduleId: 'DS-5001',
      driverId: 'driver-4',
      haulerCompany: 'Premier Fleet',
      exportSiteId: 'EX-101',
      importSiteId: 'IM-202',
      volume: 250,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 10 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 25 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 70 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 140 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      digitalSignature: 'signature-9004',
      actualVolume: 250,
      customerRating: 4.5,
      fuelUsed: 123,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9005',
      scheduleId: 'DS-5002',
      driverId: 'driver-5',
      haulerCompany: 'Rapid Logistics',
      exportSiteId: 'EX-103',
      importSiteId: 'IM-201',
      volume: 180,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 12 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 30 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 75 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 135 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      digitalSignature: 'signature-9005',
      actualVolume: 180,
      customerRating: 4.8,
      fuelUsed: 91,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9006',
      scheduleId: 'DS-5003',
      driverId: 'driver-6',
      haulerCompany: 'GreenHaul Transport',
      exportSiteId: 'EX-104',
      importSiteId: 'IM-204',
      volume: 220,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 15 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 35 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 85 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 145 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      actualVolume: 220,
      customerRating: 5,
      fuelUsed: 115,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9007',
      scheduleId: 'DS-5001',
      driverId: 'driver-7',
      haulerCompany: 'Budget Movers',
      exportSiteId: 'EX-105',
      importSiteId: 'IM-205',
      volume: 160,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 7 * 24 * 60 * 60 * 1000 + 18 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 7 * 24 * 60 * 60 * 1000 + 40 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 7 * 24 * 60 * 60 * 1000 + 90 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 7 * 24 * 60 * 60 * 1000 + 155 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      actualVolume: 160,
      customerRating: 4.2,
      fuelUsed: 82,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9008',
      scheduleId: 'DS-5002',
      driverId: 'driver-8',
      haulerCompany: 'Premier Fleet',
      exportSiteId: 'EX-101',
      importSiteId: 'IM-203',
      volume: 190,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 8 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 22 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 68 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 2 * 24 * 60 * 60 * 1000 + 128 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      digitalSignature: 'signature-9008',
      actualVolume: 190,
      customerRating: 4.9,
      fuelUsed: 98,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9009',
      scheduleId: 'DS-5003',
      driverId: 'driver-1',
      haulerCompany: 'Rapid Logistics',
      exportSiteId: 'EX-102',
      importSiteId: 'IM-201',
      volume: 175,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 14 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 32 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 77 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 3 * 24 * 60 * 60 * 1000 + 137 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      actualVolume: 175,
      customerRating: 4.6,
      fuelUsed: 88,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9010',
      scheduleId: 'DS-5001',
      driverId: 'driver-2',
      haulerCompany: 'GreenHaul Transport',
      exportSiteId: 'EX-103',
      importSiteId: 'IM-204',
      volume: 210,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 11 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 28 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 73 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 4 * 24 * 60 * 60 * 1000 + 133 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      digitalSignature: 'signature-9010',
      actualVolume: 210,
      customerRating: 4.7,
      fuelUsed: 108,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9011',
      scheduleId: 'DS-5002',
      driverId: 'driver-3',
      haulerCompany: 'Budget Movers',
      exportSiteId: 'EX-104',
      importSiteId: 'IM-202',
      volume: 185,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 16 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 38 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 82 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 5 * 24 * 60 * 60 * 1000 + 142 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      actualVolume: 185,
      customerRating: 4.3,
      fuelUsed: 95,
      gpsTrack: [],
      issues: [],
    },
    {
      id: 'T-9012',
      scheduleId: 'DS-5003',
      driverId: 'driver-4',
      haulerCompany: 'Premier Fleet',
      exportSiteId: 'EX-105',
      importSiteId: 'IM-201',
      volume: 230,
      status: 'delivered' as const,
      createdAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 9 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 24 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 69 * 60 * 1000).toISOString(),
      deliveredAt: new Date(currentTime.getTime() - 6 * 24 * 60 * 60 * 1000 + 129 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      unloadPhotoUrl: 'uploaded',
      digitalSignature: 'signature-9012',
      actualVolume: 230,
      customerRating: 5,
      fuelUsed: 118,
      gpsTrack: [],
      issues: [],
    },
    // Active/in-progress tickets
    {
      id: 'T-9013',
      scheduleId: 'DS-5001',
      driverId: 'driver-5',
      haulerCompany: 'Rapid Logistics',
      exportSiteId: 'EX-101',
      importSiteId: 'IM-203',
      volume: 175,
      status: 'en-route-delivery' as const,
      createdAt: new Date(currentTime.getTime() - 3 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 3 * 60 * 60 * 1000 + 10 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 2.5 * 60 * 60 * 1000).toISOString(),
      loadedAt: new Date(currentTime.getTime() - 2 * 60 * 60 * 1000).toISOString(),
      loadPhotoUrl: 'uploaded',
      gpsTrack: [],
      eta: new Date(currentTime.getTime() + 30 * 60 * 1000).toISOString(),
      issues: [],
    },
    {
      id: 'T-9014',
      driverId: 'driver-6',
      haulerCompany: 'GreenHaul Transport',
      exportSiteId: 'EX-102',
      importSiteId: 'IM-204',
      volume: 195,
      status: 'loading' as const,
      createdAt: new Date(currentTime.getTime() - 1 * 60 * 60 * 1000).toISOString(),
      acceptedAt: new Date(currentTime.getTime() - 50 * 60 * 1000).toISOString(),
      startedAt: new Date(currentTime.getTime() - 30 * 60 * 1000).toISOString(),
      gpsTrack: [],
      eta: new Date(currentTime.getTime() + 90 * 60 * 1000).toISOString(),
      issues: [],
    },
    {
      id: 'T-9015',
      driverId: 'driver-7',
      haulerCompany: 'Budget Movers',
      exportSiteId: 'EX-103',
      importSiteId: 'IM-205',
      volume: 165,
      status: 'pending' as const,
      createdAt: new Date(currentTime.getTime() - 15 * 60 * 1000).toISOString(),
      gpsTrack: [],
      issues: [],
    },
  ];

  dispatchStorage.setDispatchTickets(tickets);
}
